<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - RecipeHub</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* small convenience */
    .recipe-grid .recipe-card { transition: transform .08s ease; }
    .recipe-grid .recipe-card:hover { transform: translateY(-4px); }
    .btn[disabled] { opacity: 0.6; pointer-events: none; }
    .placeholder-img { width:100%; height:180px; background:#eee; display:flex; align-items:center; justify-content:center; color:#999; font-size:18px; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="container">
      <div class="nav">
        <div class="logo">
          <span class="logo-icon">üç≥</span>
          <span class="logo-text">RecipeHub</span>
        </div>
        <div class="nav-buttons">
          <a href="add-recipe.html" class="btn btn-success">+ Add Recipe</a>
          <a href="index.html" class="btn btn-outline">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Dashboard Content -->
  <main class="dashboard">
    <div class="container">

      <!-- Welcome Section -->
      <section class="dashboard-welcome">
        <h1 class="dashboard-title">Welcome back, Chef! üë®‚Äçüç≥</h1>
        <p class="dashboard-subtitle">Discover amazing recipes from our community</p>
      </section>

      <!-- Quick Actions -->
      <section class="quick-actions">
        <div class="action-cards">
          <a href="add-recipe.html" class="action-card add-recipe">
            <div class="action-icon">‚ûï</div>
            <h3>Add New Recipe</h3>
            <p>Share your favorite dish</p>
          </a>
          <a href="category.html" class="action-card browse">
            <div class="action-icon">üîç</div>
            <h3>Browse Categories</h3>
            <p>Find recipes by type</p>
          </a>
          <div class="action-card favorites">
            <div class="action-icon">‚ù§Ô∏è</div>
            <h3>My Favorites</h3>
            <p>Saved recipes</p>
          </div>
        </div>
      </section>

      <!-- Popular Recipes Section -->
      <section class="recipes">
        <h2 class="section-title">Popular Recipes üî•</h2>
        <div class="recipe-grid">

          <!-- 6 Fixed Recipe Cards (kept as-is) -->
          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Fluffy Pancakes.jpg" alt="Fluffy Pancakes" />
              <div class="recipe-category breakfast">Breakfast</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Fluffy Pancakes</h3>
              <p class="recipe-description">Perfect weekend breakfast with maple syrup and fresh berries.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 15 min</span>
                <span class="recipe-rating">‚≠ê 4.8 (120)</span>
              </div>
              <div class="recipe-author"><span>by Chef Maria</span></div>
            </div>
          </div>

          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Chicken Caesar Salad.jpg" alt="Chicken Caesar Salad" />
              <div class="recipe-category lunch">Lunch</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Chicken Caesar Salad</h3>
              <p class="recipe-description">Fresh crispy salad with grilled chicken and homemade dressing.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 25 min</span>
                <span class="recipe-rating">‚≠ê 4.6 (89)</span>
              </div>
              <div class="recipe-author"><span>by Chef Alex</span></div>
            </div>
          </div>

          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Chocolate Lava Cake.jpg" alt="Chocolate Lava Cake" />
              <div class="recipe-category dessert">Dessert</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Chocolate Lava Cake</h3>
              <p class="recipe-description">Rich chocolate cake with molten center. Perfect for special occasions.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 30 min</span>
                <span class="recipe-rating">‚≠ê 4.9 (203)</span>
              </div>
              <div class="recipe-author"><span>by Chef Sophie</span></div>
            </div>
          </div>

          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Beef Stir Fry.jpg" alt="Beef Stir Fry" />
              <div class="recipe-category dinner">Dinner</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Beef Stir Fry</h3>
              <p class="recipe-description">Quick and healthy dinner with fresh vegetables and tender beef.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 20 min</span>
                <span class="recipe-rating">‚≠ê 4.7 (156)</span>
              </div>
              <div class="recipe-author"><span>by Chef David</span></div>
            </div>
          </div>

          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Tropical Smoothie Bowl.jpg" alt="Tropical Smoothie Bowl" />
              <div class="recipe-category snacks">Snacks</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Tropical Smoothie Bowl</h3>
              <p class="recipe-description">Refreshing smoothie bowl with mango, banana and coconut flakes.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 10 min</span>
                <span class="recipe-rating">‚≠ê 4.5 (78)</span>
              </div>
              <div class="recipe-author"><span>by Chef Emma</span></div>
            </div>
          </div>

          <div class="recipe-card">
            <div class="recipe-image">
              <img src="assets/Pasta Primavera.jpg" alt="Pasta Primavera" />
              <div class="recipe-category dinner">Dinner</div>
            </div>
            <div class="recipe-content">
              <h3 class="recipe-title">Pasta Primavera</h3>
              <p class="recipe-description">Fresh vegetables and creamy sauce with perfectly cooked pasta.</p>
              <div class="recipe-meta">
                <span class="recipe-time">‚è±Ô∏è 35 min</span>
                <span class="recipe-rating">‚≠ê 4.8 (192)</span>
              </div>
              <div class="recipe-author"><span>by Chef Tony</span></div>
            </div>
          </div>

        </div>
      </section>

      <!-- Community Recipes Section -->
      <section class="recipes">
        <h2 class="section-title">Community Recipes üßë‚Äçüç≥</h2>
        <div class="recipe-grid" id="community-recipes">
          <!-- Recipes loaded from database will appear here -->
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <span class="logo-icon">üç≥</span>
          <span class="logo-text">RecipeHub</span>
        </div>
        <p>Made with ‚ù§Ô∏è for food lovers everywhere</p>
      </div>
    </div>
  </footer>

  <!-- Load Community Recipes from Backend -->
  <script>
    // Local vs deployed backend selection
    const DEFAULT_RENDER_BACKEND = 'https://recipehub-9vlb.onrender.com'; // change if different
    const API_BASE_URL = (function () {
      if (window.API_BASE_URL) return window.API_BASE_URL;
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:3000';
      return DEFAULT_RENDER_BACKEND;
    })();

    function getCategoryTag(category) {
      const categoryClass = category ? category.toLowerCase() : 'other';
      const safeName = category ? category.charAt(0).toUpperCase() + category.slice(1) : 'Other';
      return `<div class="recipe-category ${categoryClass}">${safeName}</div>`;
    }

    function safeImageUrl(imageUrl) {
      if (!imageUrl) return null;
      // if imageUrl is already absolute, return it; else prefix with API_BASE_URL
      if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) return imageUrl;
      // ensure leading slash
      if (!imageUrl.startsWith('/')) imageUrl = '/' + imageUrl;
      return API_BASE_URL + imageUrl;
    }

    async function loadCommunityRecipes() {
      const container = document.getElementById('community-recipes');
      container.innerHTML = '<p>Loading community recipes‚Ä¶</p>';
      try {
        const res = await fetch(`${API_BASE_URL}/recipes`);
        if (!res.ok) {
          container.innerHTML = '<p>‚ö†Ô∏è Failed to load community recipes.</p>';
          console.error('Failed to fetch recipes', res.status);
          return;
        }
        const data = await res.json();
        container.innerHTML = '';
        if (!data || data.length === 0) {
          container.innerHTML = "<p>No community recipes found.</p>";
          return;
        }

        data.forEach(recipe => {
          const card = document.createElement('div');
          card.className = 'recipe-card';
          const imgUrl = safeImageUrl(recipe.image_url);
          const imageHtml = imgUrl
            ? `<img src="${imgUrl}" alt="${escapeHtml(recipe.title)}" />`
            : `<div class="placeholder-img">No image</div>`;

          card.innerHTML = `
            <a href="view-recipe.html?id=${recipe.id}" style="text-decoration: none; color: inherit;">
              <div class="recipe-image">
                ${imageHtml}
                ${getCategoryTag(recipe.category)}
              </div>
              <div class="recipe-content">
                <h3 class="recipe-title">${escapeHtml(recipe.title)}</h3>
                <p class="recipe-description">${escapeHtml(recipe.description || '')}</p>
                <div class="recipe-meta">
                  <span class="recipe-time">‚è±Ô∏è ${recipe.prep_time || 0} min</span>
                </div>
                <div class="recipe-author"><span>by Community</span></div>
              </div>
            </a>
            <div class="recipe-actions">
              <button class="btn btn-danger" data-id="${recipe.id}">üóëÔ∏è Delete</button>
              <a href="edit-recipe.html?id=${recipe.id}" class="btn btn-primary">‚úèÔ∏è Edit</a>
            </div>
          `;
          container.appendChild(card);
        });

        // attach delete handlers (delegation)
        container.addEventListener('click', async function (e) {
          if (e.target && e.target.matches('.btn-danger')) {
            const btn = e.target;
            const id = btn.getAttribute('data-id');
            if (!confirm('Are you sure you want to delete this recipe?')) return;
            btn.disabled = true;
            try {
              const delRes = await fetch(`${API_BASE_URL}/recipes/${id}`, { method: 'DELETE' });
              if (delRes.ok) {
                btn.closest('.recipe-card').remove();
                alert('‚úÖ Recipe deleted!');
              } else {
                alert('‚ùå Failed to delete recipe.');
              }
            } catch (err) {
              console.error('Error deleting recipe', err);
              alert('‚ùå Error deleting recipe.');
            } finally {
              btn.disabled = false;
            }
          }
        });

      } catch (err) {
        console.error('‚ùå Error fetching recipes:', err);
        container.innerHTML = '<p>‚ö†Ô∏è Failed to load community recipes.</p>';
      }
    }

    // simple HTML escape to avoid injection when inserting text
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // load recipes on page load
    loadCommunityRecipes();
  </script>

</body>
</html>
