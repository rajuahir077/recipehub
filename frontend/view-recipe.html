<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Recipe - RecipeHub</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .recipe-image { max-width: 100%; border-radius: 12px; margin-bottom: 20px; display:block; }
    .meta { margin-bottom: 10px; display:flex; gap:10px; flex-wrap:wrap; }
    .tag { background:#f3f3f3; padding:6px 10px; border-radius:8px; font-size:14px; }
    .recipe-actions { margin-top:16px; display:flex; gap:8px; }
    .btn[disabled] { opacity:0.6; pointer-events:none; }
    .error { color: #a00; }
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <div class="nav">
        <div class="logo">
          <span class="logo-icon">üç≥</span>
          <span class="logo-text">RecipeHub</span>
        </div>
        <div class="nav-buttons">
          <a href="dashboard.html" class="btn btn-outline">‚Üê Back to Dashboard</a>
        </div>
      </div>
    </div>
  </header>

  <main class="recipe-view">
    <div class="container" id="recipeContainer">
      <h1 class="page-title">Loading recipe...</h1>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>Made with ‚ù§Ô∏è RecipeHub</p>
    </div>
  </footer>

  <script>
    // API base selection (local vs deployed)
    const DEFAULT_RENDER_BACKEND = 'https://recipehub-9vlb.onrender.com'; // change if different
    const API_BASE = (function(){
      if (window.API_BASE_URL) return window.API_BASE_URL;
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'https://recipehub-9vlb.onrender.com';
      return DEFAULT_RENDER_BACKEND;
    })();

    // helpers
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function safeImageUrl(imageUrl) {
      if (!imageUrl) return null;
      if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) return imageUrl;
      // ensure leading slash
      if (!imageUrl.startsWith('/')) imageUrl = '/' + imageUrl;
      return API_BASE + imageUrl;
    }

    // read id
    const params = new URLSearchParams(window.location.search);
    const recipeId = params.get('id');

    async function loadRecipe() {
      const container = document.getElementById('recipeContainer');
      if (!recipeId) {
        container.innerHTML = '<p class="error">No recipe id provided.</p>';
        return;
      }

      container.innerHTML = '<h1 class="page-title">Loading recipe...</h1>';
      try {
        const res = await fetch(`${API_BASE}/recipes/${encodeURIComponent(recipeId)}`);
        if (!res.ok) {
          const body = await res.json().catch(()=>({}));
          container.innerHTML = `<p class="error">${escapeHtml(body.error || 'Recipe not found.')}</p>`;
          return;
        }

        const recipe = await res.json();

        // build HTML
        const imgUrl = safeImageUrl(recipe.image_url);
        const imageHtml = imgUrl ? `<img src="${imgUrl}" alt="${escapeHtml(recipe.title)}" class="recipe-image" />` : '';

        const ingredientsHtml = (Array.isArray(recipe.ingredients) && recipe.ingredients.length)
          ? recipe.ingredients.map(i => `<li>üü¢ ${escapeHtml(i)}</li>`).join('')
          : `<li style="color:gray">No ingredients listed.</li>`;

        const instructionsHtml = (Array.isArray(recipe.instructions) && recipe.instructions.length)
          ? recipe.instructions.map(step => `<li>‚úÖ ${escapeHtml(step)}</li>`).join('')
          : `<li style="color:gray">No instructions provided.</li>`;

        container.innerHTML = `
          <h1 class="page-title">${escapeHtml(recipe.title)}</h1>
          ${imageHtml}
          <div class="meta">
            <div class="tag">üìÇ ${escapeHtml(recipe.category || 'Uncategorized')}</div>
            <div class="tag">‚è± ${escapeHtml(recipe.prep_time || 0)} min</div>
            <div class="tag">üçΩ Serves: ${escapeHtml(recipe.servings || '')}</div>
          </div>
          <p class="description" style="margin-bottom:25px;">${escapeHtml(recipe.description || '')}</p>

          <h2>üìú Ingredients</h2>
          <ul class="ingredients-list" style="margin-bottom:20px;">
            ${ingredientsHtml}
          </ul>

          <h2>üë®‚Äçüç≥ Instructions</h2>
          <ol class="instructions-list">
            ${instructionsHtml}
          </ol>

          <div class="recipe-actions">
            <a class="btn btn-primary" id="editBtn" href="edit-recipe.html?id=${encodeURIComponent(recipe.id)}">‚úèÔ∏è Edit</a>
            <button class="btn btn-danger" id="deleteBtn">üóëÔ∏è Delete</button>
          </div>
        `;

        // attach delete handler
        document.getElementById('deleteBtn').addEventListener('click', async function () {
          if (!confirm('Are you sure you want to delete this recipe?')) return;
          const btn = this;
          btn.disabled = true;
          try {
            const delRes = await fetch(`${API_BASE}/recipes/${encodeURIComponent(recipe.id)}`, { method: 'DELETE' });
            if (delRes.ok) {
              alert('‚úÖ Recipe deleted.');
              window.location.href = 'dashboard.html';
            } else {
              const errBody = await delRes.json().catch(()=>({}));
              alert('Failed to delete: ' + (errBody.error || delRes.status));
              btn.disabled = false;
            }
          } catch (err) {
            console.error('Delete error', err);
            alert('Network error deleting recipe.');
            btn.disabled = false;
          }
        });

      } catch (err) {
        console.error('Load recipe error', err);
        container.innerHTML = '<p class="error">An error occurred while loading the recipe.</p>';
      }
    }

    loadRecipe();
  </script>
</body>
</html>

