<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Recipe - RecipeHub</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    button[disabled] { opacity: 0.6; pointer-events: none; }
    #imagePreview { max-width: 200px; margin-top: 10px; display: none; }
  </style>
</head>

<body>

<header class="header">
  <div class="container">
    <div class="nav">
      <div class="logo">
        <span class="logo-icon">üç≥</span>
        <span class="logo-text">RecipeHub</span>
      </div>
      <div class="nav-buttons">
        <a href="dashboard.html" class="btn btn-outline">‚Üê Back to Dashboard</a>
      </div>
    </div>
  </div>
</header>

<main class="add-recipe">
  <div class="container">
    <h1>Edit Your Recipe üçΩÔ∏è</h1>

    <form class="recipe-form" id="editForm" enctype="multipart/form-data">

      <input type="text" id="title" class="form-input" placeholder="Recipe Title" required/>

      <select id="category" class="form-select" required>
        <option value="">Select Category</option>
        <option value="breakfast">üç≥ Breakfast</option>
        <option value="lunch">ü•ó Lunch</option>
        <option value="dinner">üçΩÔ∏è Dinner</option>
        <option value="dessert">üç∞ Dessert</option>
        <option value="snacks">üçø Snacks</option>
        <option value="drinks">ü•§ Drinks</option>
      </select>

      <input type="number" id="prepTime" class="form-input" placeholder="Prep Time (min)"/>
      <input type="number" id="servings" class="form-input" placeholder="Servings"/>

      <textarea id="description" class="form-textarea" rows="3" placeholder="Description"></textarea>

      <h3>Current Image</h3>
      <img id="currentImage" style="max-width:200px; display:none;">
      <p id="noImageMsg">No image uploaded</p>

      <h3>Replace Image (optional)</h3>
      <input type="file" id="image" class="form-input" accept="image/*"/>
      <img id="imagePreview"/>

      <h3>Ingredients</h3>
      <div id="ingredients"></div>
      <button type="button" class="btn btn-outline" onclick="addIngredient()">+ Ingredient</button>

      <h3>Instructions</h3>
      <div id="instructions"></div>
      <button type="button" class="btn btn-outline" onclick="addStep()">+ Step</button>

      <button type="submit" id="saveBtn" class="btn btn-success">Update Recipe ‚úÖ</button>
    </form>
  </div>
</main>

<script>
/* ------------------------------
   BACKEND URL CONFIG
--------------------------------*/
const DEFAULT_BACKEND = "https://recipehub-9vlb.onrender.com";
const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
  ? "http://localhost:3000"
  : DEFAULT_BACKEND;

/* ------------------------------
   GET RECIPE ID FROM URL
--------------------------------*/
const params = new URLSearchParams(window.location.search);
const recipeId = params.get("id");

/* ------------------------------
   LOAD RECIPE DETAILS
--------------------------------*/
async function loadRecipe() {
  try {
    const res = await fetch(`${API_BASE}/recipes/${recipeId}`);
    if (!res.ok) {
      alert("Failed to load recipe.");
      return;
    }

    const recipe = await res.json();

    // Fill fields
    title.value = recipe.title;
    category.value = recipe.category;
    prepTime.value = recipe.prep_time;
    servings.value = recipe.servings;
    description.value = recipe.description;

    // Image
    if (recipe.image_url) {
      currentImage.src = recipe.image_url.startsWith("http")
        ? recipe.image_url
        : API_BASE + recipe.image_url;
      currentImage.style.display = "block";
      noImageMsg.style.display = "none";
    } else {
      currentImage.style.display = "none";
    }

    // Ingredients
    ingredients.innerHTML = "";
    recipe.ingredients.forEach(ing => addIngredient(ing));

    // Instructions
    instructions.innerHTML = "";
    recipe.instructions.forEach(step => addStep(step));

  } catch (err) {
    console.error(err);
    alert("Error loading recipe.");
  }
}

/* ------------------------------
   ADD / REMOVE INGREDIENT / STEP
--------------------------------*/
function addIngredient(value = "") {
  const div = document.createElement("div");
  div.innerHTML = `<input type="text" class="form-input ingredient-input" value="${value}"/>`;
  ingredients.appendChild(div);
}

function addStep(value = "") {
  const div = document.createElement("div");
  div.innerHTML = `<textarea class="form-textarea step-input" rows="2">${value}</textarea>`;
  instructions.appendChild(div);
}

/* ------------------------------
   IMAGE PREVIEW
--------------------------------*/
image.addEventListener("change", e => {
  const file = e.target.files[0];
  if (file) {
    imagePreview.src = URL.createObjectURL(file);
    imagePreview.style.display = "block";
  }
});

/* ------------------------------
   SUBMIT UPDATE
--------------------------------*/
document.getElementById("editForm").addEventListener("submit", async e => {
  e.preventDefault();

  saveBtn.disabled = true;

  const formData = new FormData();
  formData.append("title", title.value);
  formData.append("category", category.value);
  formData.append("prepTime", prepTime.value);
  formData.append("servings", servings.value);
  formData.append("description", description.value);

  const imgFile = image.files[0];
  if (imgFile) formData.append("image", imgFile);

  const ingList = [...document.querySelectorAll(".ingredient-input")].map(i => i.value);
  formData.append("ingredients", JSON.stringify(ingList));

  const stepList = [...document.querySelectorAll(".step-input")].map(i => i.value);
  formData.append("instructions", JSON.stringify(stepList));

  try {
    const res = await fetch(`${API_BASE}/recipes/${recipeId}`, {
      method: "PUT",
      body: formData
    });

    if (res.ok) {
      alert("Recipe updated successfully!");
      window.location.href = `view-recipe.html?id=${recipeId}`;
    } else {
      const err = await res.json();
      alert("Update failed: " + err.error);
    }
  } catch (err) {
    alert("Network error.");
  } finally {
    saveBtn.disabled = false;
  }
});

/* ------------------------------ */
loadRecipe();
</script>

<footer class="footer">
  <div class="container">
    <p>Made with ‚ù§Ô∏è RecipeHub</p>
  </div>
</footer>

</body>
</html>
